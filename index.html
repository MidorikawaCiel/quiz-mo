<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨˜å…¥å¼ãƒ©ãƒ³ãƒ€ãƒ ã‚¯ã‚¤ã‚º</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* ãƒ©ã‚¤ãƒˆã‚°ãƒ¬ãƒ¼ã®èƒŒæ™¯ */
        }
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«: ãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼åŠ¹æœ */
        .btn-theme:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-theme {
            transition: all 0.2s ease-in-out;
        }
        /* UIã®ä¸»è¦ãªã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #submit-answer-btn:disabled {
            background-color: #9ca3af; /* Tailwind gray-400 */
            cursor: not-allowed;
        }
        /* å…¥åŠ›ã‚¨ãƒ©ãƒ¼æ™‚ã®æ ç·š */
        .input-error {
            border-color: #ef4444 !important; /* Tailwind red-500 */
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div id="app" class="w-full max-w-lg">
        <div id="loading-screen" class="flex flex-col items-center justify-center p-8 card transition-opacity duration-300">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
            <p class="mt-4 text-lg text-indigo-600 font-semibold">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>

        <!-- 1. ãƒ†ãƒ¼ãƒé¸æŠç”»é¢ (Theme Selection Screen) -->
        <div id="theme-selection-screen" class="hidden card p-6 md:p-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">ã‚¯ã‚¤ã‚ºã®ãƒ†ãƒ¼ãƒã‚’é¸ã¶</h1>
            
            <!-- æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã®è¿½åŠ  -->
            <input type="text" id="theme-search-input"
                   class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-lg mb-6"
                   placeholder="ãƒ†ãƒ¼ãƒã‚’æ¤œç´¢..."
                   autocomplete="off">

            <div id="theme-list" class="grid grid-cols-1 gap-4">
                <!-- ãƒ†ãƒ¼ãƒãƒœã‚¿ãƒ³ãŒJSã«ã‚ˆã£ã¦æŒ¿å…¥ã•ã‚Œã¾ã™ -->
            </div>
            <!-- æ¤œç´¢çµæœãªã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <p id="no-themes-message" class="hidden text-center text-gray-500 mt-4">è©²å½“ã™ã‚‹ãƒ†ãƒ¼ãƒã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
        </div>

        <!-- 1.5. ã‚¯ã‚¤ã‚ºé–‹å§‹ç¢ºèªç”»é¢ (Confirmation Screen) -->
        <div id="confirmation-screen" class="hidden card p-6 md:p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ</h2>
            
            <div class="bg-indigo-50 p-4 rounded-lg mb-6">
                <p class="text-lg font-semibold text-indigo-700 mb-2">ãƒ†ãƒ¼ãƒ:</p>
                <p id="confirm-theme-title" class="text-2xl font-extrabold text-gray-800 mb-4"></p>
                
                <p class="text-lg font-semibold text-indigo-700 mb-2">æ¦‚è¦:</p>
                <p id="confirm-theme-description" class="text-base text-gray-700"></p>
                
                <p class="text-base text-gray-500 mt-4">å‡ºé¡Œæ•°: <span class="font-bold">ãƒ©ãƒ³ãƒ€ãƒ 10å•</span></p>
            </div>
            
            <div class="flex space-x-4 mt-6">
                <button id="start-quiz-btn"
                        class="flex-1 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition duration-150">
                    ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆ
                </button>
                <button id="cancel-quiz-btn"
                        class="flex-1 py-3 bg-gray-400 text-white font-bold rounded-lg hover:bg-gray-500 transition duration-150">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
            </div>
        </div>

        <!-- 2. ã‚¯ã‚¤ã‚ºç”»é¢ (Quiz Screen) -->
        <div id="quiz-screen" class="hidden card p-6 md:p-8">
            <h2 id="quiz-theme-title" class="text-xl font-semibold text-indigo-600 mb-4 border-b pb-2"></h2>
            <div class="text-sm font-medium text-gray-500 mb-6">
                <span id="question-counter"></span>
                <span id="answer-type-display" class="ml-2 px-2 py-1 bg-gray-200 text-gray-600 rounded-full text-xs"></span>
            </div>

            <div class="bg-indigo-50 p-4 rounded-lg mb-6">
                <p id="question-text" class="text-xl font-bold text-gray-800"></p>
            </div>

            <input type="text" id="user-answer-input"
                   class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-lg mb-2"
                   placeholder="è§£ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (åˆ¶é™ãªã—)"
                   autocomplete="off">
            
            <!-- å…¥åŠ›ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <p id="validation-message" class="text-red-500 text-sm mb-4 hidden">
                âš ï¸ æŒ‡å®šã•ã‚ŒãŸæ–‡å­—ç¨®ä»¥å¤–ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
            </p>

            <button id="submit-answer-btn"
                    class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-150">
                è§£ç­”ã‚’æå‡º
            </button>
            
            <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¨è§£èª¬ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®è¦ç´  -->
            <div id="feedback-message" class="mt-4 p-3 rounded-lg text-center hidden font-semibold"></div>
            <div id="explanation-text" class="mt-4 p-3 rounded-lg bg-gray-100 text-gray-700 hidden text-sm"></div>
        </div>

        <!-- 3. çµæœç”»é¢ (Result Screen) -->
        <div id="result-screen" class="hidden card p-8 text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">ã‚¯ã‚¤ã‚ºçµ‚äº†ï¼</h2>
            <p class="text-6xl font-extrabold text-indigo-600 mb-6">
                <span id="final-score">0</span> / <span id="total-questions">10</span>
            </p>
            <p id="result-message" class="text-xl text-gray-600 mb-8"></p>
            
            <button id="restart-btn"
                    class="w-full py-3 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition duration-150">
                åˆ¥ã®ãƒ†ãƒ¼ãƒã§å†ã‚¹ã‚¿ãƒ¼ãƒˆ
            </button>
        </div>
    </div>

    <!-- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ -->
    <script>
        // --- é™çš„ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ ---
        const staticQuizzes = [
            {
                themeName: "æ—¥æœ¬ã®éƒ½é“åºœçœŒåºæ‰€åœ¨åœ°",
                id: "kenchoshozaichi",
                description: "éƒ½é“åºœçœŒåã‚’ç¤ºã™ã®ã§çœŒåºæ‰€åœ¨åœ°ã‚’ç­”ãˆã¦ãã ã•ã„ã€‚",
                questions: [
                    { 
                        question: "åŒ—æµ·é“", 
                        answers: ["æœ­å¹Œå¸‚", "ã•ã£ã½ã‚ã—", "æœ­å¹Œ", "ã•ã£ã½ã‚"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "é’æ£®çœŒ", 
                        answers: ["é’æ£®å¸‚", "ã‚ãŠã‚‚ã‚Šã—", "é’æ£®", "ã‚ãŠã‚‚ã‚Š"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "å²©æ‰‹çœŒ", 
                        answers: ["ç››å²¡å¸‚", "ã‚‚ã‚ŠãŠã‹ã—", "ç››å²¡", "ã‚‚ã‚ŠãŠã‹"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "å®®åŸçœŒ", 
                        answers: ["ä»™å°å¸‚", "ã›ã‚“ã ã„ã—", "ä»™å°", "ã›ã‚“ã ã„"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "ç§‹ç”°çœŒ", 
                        answers: ["ç§‹ç”°å¸‚", "ã‚ããŸã—", "ç§‹ç”°", "ã‚ããŸ"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "å±±å½¢çœŒ", 
                        answers: ["å±±å½¢å¸‚", "ã‚„ã¾ãŒãŸã—", "å±±å½¢", "ã‚„ã¾ãŒãŸ"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "ç¦å³¶çœŒ", 
                        answers: ["ç¦å³¶å¸‚", "ãµãã—ã¾ã—", "ç¦å³¶", "ãµãã—ã¾"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "èŒ¨åŸçœŒ", 
                        answers: ["æ°´æˆ¸å¸‚", "ã¿ã¨ã—", "ã¿ã¨", "ã¿ã¨ã—"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "æ ƒæœ¨çœŒ", 
                        answers: ["å®‡éƒ½å®®å¸‚", "ã†ã¤ã®ã¿ã‚„ã—", "å®‡éƒ½å®®", "ã†ã¤ã®ã¿ã‚„"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "ç¾¤é¦¬çœŒ", 
                        answers: ["å‰æ©‹å¸‚", "ã¾ãˆã°ã—ã—", "å‰æ©‹", "ã¾ãˆã°ã—"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "åŸ¼ç‰çœŒ", 
                        answers: ["ã•ã„ãŸã¾å¸‚", "ã•ã„ãŸã¾ã—", "ã•ã„ãŸã¾"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "åƒè‘‰çœŒ", 
                        answers: ["åƒè‘‰å¸‚", "ã¡ã°ã—", "åƒè‘‰", "ã¡ã°"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "ç¥å¥ˆå·çœŒ", 
                        answers: ["æ¨ªæµœå¸‚", "ã‚ˆã“ã¯ã¾ã—", "æ¨ªæµœ", "ã‚ˆã“ã¯ã¾"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "æ–°æ½ŸçœŒ", 
                        answers: ["æ–°æ½Ÿå¸‚", "ã«ã„ãŒãŸã—", "æ–°æ½Ÿ", "ã«ã„ãŒãŸ"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "å¯Œå±±çœŒ", 
                        answers: ["å¯Œå±±å¸‚", "ã¨ã‚„ã¾ã—", "å¯Œå±±", "ã¨ã‚„ã¾"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "çŸ³å·çœŒ", 
                        answers: ["é‡‘æ²¢å¸‚", "ã‹ãªã–ã‚ã—", "é‡‘æ²¢", "ã‹ãªã–ã‚"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "ç¦äº•çœŒ", 
                        answers: ["ç¦äº•å¸‚", "ãµãã„ã—", "ç¦äº•", "ãµãã„"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "å±±æ¢¨çœŒ", 
                        answers: ["ç”²åºœå¸‚", "ã“ã†ãµã—", "ç”²åºœ", "ã“ã†ãµ"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "é•·é‡çœŒ", 
                        answers: ["é•·é‡å¸‚", "ãªãŒã®ã—", "é•·é‡", "ãªãŒã®"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "å²é˜œçœŒ", 
                        answers: ["å²é˜œå¸‚", "ããµã—", "å²é˜œ", "ããµ"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "æ„›çŸ¥çœŒ", 
                        answers: ["åå¤å±‹å¸‚", "ãªã”ã‚„ã—", "åå¤å±‹", "ãªã”ã‚„"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "ä¸‰é‡çœŒ", 
                        answers: ["æ´¥å¸‚", "ã¤ã—", "æ´¥", "ã¤"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "æ»‹è³€çœŒ", 
                        answers: ["å¤§æ´¥å¸‚", "ãŠãŠã¤ã—", "å¤§æ´¥", "ãŠãŠã¤"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "äº¬éƒ½åºœ", 
                        answers: ["äº¬éƒ½å¸‚", "ãã‚‡ã†ã¨ã—", "äº¬éƒ½", "ãã‚‡ã†ã¨"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "å¤§é˜ªåºœ", 
                        answers: ["å¤§é˜ªå¸‚", "ãŠãŠã•ã‹ã—", "å¤§é˜ª", "ãŠãŠã•ã‹"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "å…µåº«çœŒ", 
                        answers: ["ç¥æˆ¸å¸‚", "ã“ã†ã¹ã—", "ç¥æˆ¸", "ã“ã†ã¹"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "å¥ˆè‰¯çœŒ", 
                        answers: ["å¥ˆè‰¯å¸‚", "ãªã‚‰ã—", "å¥ˆè‰¯", "ãªã‚‰"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "å’Œæ­Œå±±çœŒ", 
                        answers: ["å’Œæ­Œå±±å¸‚", "ã‚ã‹ã‚„ã¾ã—", "å’Œæ­Œå±±", "ã‚ã‹ã‚„ã¾"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "é³¥å–çœŒ", 
                        answers: ["é³¥å–å¸‚", "ã¨ã£ã¨ã‚Šã—", "é³¥å–", "ã¨ã£ã¨ã‚Š"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "å³¶æ ¹çœŒ", 
                        answers: ["æ¾æ±Ÿå¸‚", "ã¾ã¤ãˆã—", "æ¾æ±Ÿ", "ã¾ã¤ãˆ"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "å²¡å±±çœŒ", 
                        answers: ["å²¡å±±å¸‚", "ãŠã‹ã‚„ã¾ã—", "å²¡å±±", "ãŠã‹ã‚„ã¾"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "åºƒå³¶çœŒ", 
                        answers: ["åºƒå³¶å¸‚", "ã²ã‚ã—ã¾ã—", "åºƒå³¶", "ã²ã‚ã—ã¾"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "å±±å£çœŒ", 
                        answers: ["å±±å£å¸‚", "ã‚„ã¾ãã¡ã—", "å±±å£", "ã‚„ã¾ãã¡"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "å¾³å³¶çœŒ", 
                        answers: ["å¾³å³¶å¸‚", "ã¨ãã—ã¾ã—", "å¾³å³¶", "ã¨ãã—ã¾"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "é¦™å·çœŒ", 
                        answers: ["é«˜æ¾å¸‚", "ãŸã‹ã¾ã¤ã—", "é«˜æ¾", "ãŸã‹ã¾ã¤"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "æ„›åª›çœŒ", 
                        answers: ["æ¾å±±å¸‚", "ã¾ã¤ã‚„ã¾ã—", "æ¾å±±", "ã¾ã¤ã‚„ã¾"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "é«˜çŸ¥çœŒ", 
                        answers: ["é«˜çŸ¥å¸‚", "ã“ã†ã¡ã—", "é«˜çŸ¥", "ã“ã†ã¡"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "ç¦å²¡çœŒ", 
                        answers: ["ç¦å²¡å¸‚", "ãµããŠã‹ã—", "ç¦å²¡", "ãµããŠã‹"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "ä½è³€çœŒ", 
                        answers: ["ä½è³€å¸‚", "ã•ãŒã—", "ä½è³€", "ã•ãŒ"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "é•·å´çœŒ", 
                        answers: ["é•·å´å¸‚", "ãªãŒã•ãã—", "é•·å´", "ãªãŒã•ã"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "ç†Šæœ¬çœŒ", 
                        answers: ["ç†Šæœ¬å¸‚", "ãã¾ã‚‚ã¨ã—", "ç†Šæœ¬", "ãã¾ã‚‚ã¨"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "å¤§åˆ†çœŒ", 
                        answers: ["å¤§åˆ†å¸‚", "ãŠãŠã„ãŸã—", "å¤§åˆ†", "ãŠãŠã„ãŸ"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "å®®å´çœŒ", 
                        answers: ["å®®å´å¸‚", "ã¿ã‚„ã–ãã—", "å®®å´", "ã¿ã‚„ã–ã"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "é¹¿å…å³¶çœŒ", 
                        answers: ["é¹¿å…å³¶å¸‚", "ã‹ã”ã—ã¾ã—", "é¹¿å…å³¶", "ã‹ã”ã—ã¾"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                    { 
                        question: "æ²–ç¸„çœŒ", 
                        answers: ["é‚£è¦‡å¸‚", "ãªã¯ã—", "é‚£è¦‡", "ãªã¯"],
                        explanation: "",
                        answerType: "unlimited"
                    },
                ]
            },
            {
                themeName: "æ—¥æœ¬ã®ä½œå®¶(ä»£è¡¨ä½œâ†’ä½œå®¶)",
                id: "japanese_writer",
                description: "ä»£è¡¨ä½œã‚’ç¤ºã™ã®ã§ä½œå®¶ã®ãƒšãƒ³ãƒãƒ¼ãƒ ã‚’ä»®åã§ç­”ãˆã¦ãã ã•ã„ã€‚",
                questions: [
                    { 
                        question: "ã€æ—¥æœ¬ã®é»’ã„éœ§ã€ã€ç‚¹ã¨ç·šã€", 
                        answers: ["ã¾ã¤ã‚‚ã¨ã›ã„ã¡ã‚‡ã†"],
                        explanation: "æ¾æœ¬æ¸…å¼µ",
                        answerType: "kana"
                    },
                    { 
                        question: "ã€ç”°èˆæ•™å¸«ã€ã€è’²å›£ã€", 
                        answers: ["ãŸã‚„ã¾ã‹ãŸã„"],
                        explanation: "ç”°å±±èŠ±è¢‹",
                        answerType: "kana" 
                    },
                    { 
                        question: "ã€ã‚»ãƒ­å¼¾ãã®ã‚´ãƒ¼ã‚·ãƒ¥ã€ã€é¢¨ã®åˆä¸‰éƒã€ã€éŠ€æ²³é‰„é“ã®å¤œã€", 
                        answers: ["ã¿ã‚„ã–ã‚ã‘ã‚“ã˜"],
                        explanation: "å®®æ²¢è³¢æ²»",
                        answerType: "kana"
                    },
                    { 
                        question: "ã€å¤éƒ½ã€ã€é›ªå›½ã€ã€ä¼Šè±†ã®è¸Šå­ã€", 
                        answers: ["ã‹ã‚ã°ãŸã‚„ã™ãªã‚Š"],
                        explanation: "å·ç«¯åº·æˆ",
                        answerType: "kana"
                    },
                    { 
                        question: "ã€é£¼è‚²ã€ã€ä¸‡å»¶å…ƒå¹´ã®ãƒ•ãƒƒãƒˆãƒœãƒ¼ãƒ«ã€", 
                        answers: ["ãŠãŠãˆã‘ã‚“ã–ã¶ã‚ã†"],
                        explanation: "å¤§æ±Ÿå¥ä¸‰éƒ",
                        answerType: "kana"
                    },
                    { 
                        question: "ã€ã“ã‚ã‚ã€ã€åŠã£ã¡ã‚ƒã‚“ã€ã€å¾è¼©ã¯çŒ«ã§ã‚ã‚‹ã€", 
                        answers: ["ãªã¤ã‚ãã†ã›ã"],
                        explanation: "å¤ç›®æ¼±çŸ³",
                        answerType: "kana"
                    },
                    { 
                        question: "ã€ã¾ãŸã€åŒã˜å¤¢ã‚’ã¿ã¦ã„ãŸã€ã€é’ãã¦ç—›ãã¦è„†ã„ã€ã€å›ã®è†µè‡“ã‚’ãŸã¹ãŸã„ã€", 
                        answers: ["ã™ã¿ã®ã‚ˆã‚‹"],
                        explanation: "ä½é‡ã‚ˆã‚‹",
                        answerType: "kana"
                    },
                    { 
                        question: "ã€æ«»ã®æ¨¹ã®ä¸‹ã«ã¯ã€ã€æª¸æª¬ã€", 
                        answers: ["ã‹ã˜ã„ã‚‚ã¨ã˜ã‚ã†"],
                        explanation: "æ¢¶äº•åŸºæ¬¡éƒ",
                        answerType: "kana"
                    },
                    { 
                        question: "ã€é›ã€ã€é«˜ç€¬èˆŸã€ã€èˆå§«ã€", 
                        answers: ["ã‚‚ã‚ŠãŠã†ãŒã„"],
                        explanation: "æ£®é´å¤–",
                        answerType: "kana"
                    },
                    { 
                        question: "ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ã€è¹´ã‚ŠãŸã„èƒŒä¸­ã€", 
                        answers: ["ã‚ãŸã‚„ã‚Šã•"],
                        explanation: "ç¶¿çŸ¢ã‚Šã•",
                        answerType: "kana"
                    },
                    { 
                        question: "ã€æµ·è¾ºã®ã‚«ãƒ•ã‚«ã€ã€1Q84ã€ã€ãƒãƒ«ã‚¦ã‚§ã‚¤ã®æ£®ã€", 
                        answers: ["ã‚€ã‚‰ã‹ã¿ã¯ã‚‹ã"],
                        explanation: "æ‘ä¸Šæ˜¥æ¨¹",
                        answerType: "kana"
                    },
                    { 
                        question: "ã€è¥¿æ´‹é“ä¸­è†æ —æ¯›ã€ã€å®‰æ„šæ¥½é‹ã€", 
                        answers: ["ã‹ãªãŒãã‚ã¶ã‚“"],
                        explanation: "ä»®åå£é­¯æ–‡",
                        answerType: "kana"
                    },
                    { 
                        question: "ã€å‚ã®ä¸Šã®é›²ã€ã€å›½ç›—ã‚Šç‰©èªã€ã€ç«œé¦¬ãŒã‚†ãã€", 
                        answers: ["ã—ã°ã‚Šã‚‡ã†ãŸã‚ã†"],
                        explanation: "å¸é¦¬é¼å¤ªéƒ",
                        answerType: "kana"
                    },
                    { 
                        question: "ã€èµ¤é ­å·¾ã¡ã‚ƒã‚“æ°—ã‚’ã¤ã‘ã¦ã€", 
                        answers: ["ã—ã‚‡ã†ã˜ã‹ãŠã‚‹"],
                        explanation: "åº„å¸è–«",
                        answerType: "kana"
                    },
                    { 
                        question: "ã€å°èª¬ç·è«–ã€ã€æµ®é›²ã€", 
                        answers: ["ãµãŸã°ã¦ã„ã—ã‚ã„"],
                        explanation: "äºŒè‘‰äº­å››è¿·",
                        answerType: "kana"
                    },
                    { 
                        question: "ã€ç ´æˆ’ã€ã€æ˜¥ã€ã€è‹¥èœé›†ã€", 
                        answers: ["ã—ã¾ã–ãã¨ã†ãã‚“"],
                        explanation: "å³¶å´è—¤æ‘",
                        answerType: "kana"
                    },
                ]
            },
            {
                themeName: "ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã®ç•¥ç§°(æ­£å¼åç§°â†’ç•¥ç§°)",
                id: "initial",
                description: "ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã®ç•¥ç§°ã«ã—ã¦ãã ã•ã„ã€‚",
                questions: [
                    { 
                        question: "æ¬§å·é€£åˆ", 
                        answers: ["EU"],
                        explanation: "European Union",
                        answerType: "alphabet"
                    },
                    { 
                        question: "ä¸–ç•Œè²¿æ˜“æ©Ÿé–¢", 
                        answers: ["WTO"],
                        explanation: "World Trade Organization",
                        answerType: "alphabet" // æ–°ã—ã„åˆ¶é™: æ•°å­—ã¨ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã®ã¿
                    },
                    { 
                        question: "æ—¥æœ¬æ”¾é€å”ä¼š", 
                        answers: ["NHK"],
                        explanation: "Nippon Hoso Kyokai",
                        answerType: "alphabet"
                    },
                    { 
                        question: "é€£åˆå›½è»ç·å¸ä»¤éƒ¨", 
                        answers: ["GHQ"],
                        explanation: "General Headquarters",
                        answerType: "alphabet"
                    },
                    { 
                        question: "ä¸­å¤®å‡¦ç†è£…ç½®", 
                        answers: ["CPU"],
                        explanation: "central processing unit",
                        answerType: "alphabet"
                    },
                    { 
                        question: "é–¢ç¨åŠã³è²¿æ˜“ã«é–¢ã™ã‚‹ä¸€èˆ¬å”å®š", 
                        answers: ["GATT"],
                        explanation: "General Agreement on Tariffs and Trade",
                        answerType: "alphabet"
                    },
                    { 
                        question: "ä»®æƒ³ç¾å®Ÿ", 
                        answers: ["VR"],
                        explanation: "virtual reality",
                        answerType: "alphabet"
                    },
                    { 
                        question: "å›½å†…ç·ç”Ÿç”£", 
                        answers: ["GDP"],
                        explanation: "gross domestic product",
                        answerType: "alphabet"
                    },
                    { 
                        question: "å¾Œå¤©æ€§å…ç–«ä¸å…¨ç—‡å€™ç¾¤", 
                        answers: ["AIDS"],
                        explanation: "Acquired immune deficiency syndrome",
                        answerType: "alphabet"
                    },
                    { 
                        question: "ãƒ¢ãƒã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ", 
                        answers: ["IoT"],
                        explanation: "Internet of Things",
                        answerType: "alphabet"
                    },
                    { 
                        question: "ãƒãƒªãƒ¡ãƒ©ãƒ¼ã‚¼é€£é–åå¿œ", 
                        answers: ["PCR"],
                        explanation: "polymerase chain reaction",
                        answerType: "alphabet"
                    },
                    { 
                        question: "ãƒ‡ã‚ªã‚­ã‚·ãƒªãƒœæ ¸é…¸", 
                        answers: ["DNA"],
                        explanation: "deoxyribonucleic acid",
                        answerType: "alphabet"
                    },
                ]
            },
            {
                themeName: "ãƒ›ãƒ«ã‚¹ãƒˆã€æƒ‘æ˜Ÿã€(å‰¯é¡Œâ†’æ›²å)",
                id: "japanese_writer",
                description: "ãƒ›ãƒ«ã‚¹ãƒˆã®çµ„æ›²ã€æƒ‘æ˜Ÿã€ã®å‰¯é¡Œã‚’ç¤ºã™ã®ã§æ›²åã‚’ç­”ãˆã¦ãã ã•ã„ã€‚â€»ä»®åå…¥åŠ›",
                questions: [
                    { 
                        question: "æˆ¦äº‰ã‚’ã‚‚ãŸã‚‰ã™è€…", 
                        answers: ["ã‹ã›ã„"],
                        explanation: "ã€ç«æ˜Ÿã€",
                        answerType: "kana"
                    },
                    { 
                        question: "å¹³å’Œã‚’ã‚‚ãŸã‚‰ã™è€…", 
                        answers: ["ãã‚“ã›ã„"],
                        explanation: "ã€é‡‘æ˜Ÿã€",
                        answerType: "kana" 
                    },
                    { 
                        question: "ç¿¼ã®ã‚ã‚‹ä½¿è€…", 
                        answers: ["ã™ã„ã›ã„"],
                        explanation: "ã€æ°´æ˜Ÿã€",
                        answerType: "kana"
                    },
                    { 
                        question: "å¿«æ¥½ã‚’ã‚‚ãŸã‚‰ã™è€…", 
                        answers: ["ã‚‚ãã›ã„"],
                        explanation: "ã€æœ¨æ˜Ÿã€",
                        answerType: "kana"
                    },
                    { 
                        question: "è€ã„ã‚’ã‚‚ãŸã‚‰ã™è€…", 
                        answers: ["ã©ã›ã„"],
                        explanation: "ã€åœŸæ˜Ÿã€",
                        answerType: "kana"
                    },
                    { 
                        question: "é­”è¡“å¸«", 
                        answers: ["ã¦ã‚“ã®ã†ã›ã„"],
                        explanation: "ã€å¤©ç‹æ˜Ÿã€",
                        answerType: "kana"
                    },
                    { 
                        question: "ç¥ç§˜ä¸»ç¾©è€…", 
                        answers: ["ã‹ã„ãŠã†ã›ã„"],
                        explanation: "ã€æµ·ç‹æ˜Ÿã€",
                        answerType: "kana"
                    },
                ]
            },
        ];

        // --- UIè¦ç´ ã®å–å¾— ---
        const loadingScreen = document.getElementById('loading-screen');
        const themeSelectionScreen = document.getElementById('theme-selection-screen');
        const confirmationScreen = document.getElementById('confirmation-screen'); 
        const quizScreen = document.getElementById('quiz-screen');
        const resultScreen = document.getElementById('result-screen');
        const themeList = document.getElementById('theme-list');
        const themeSearchInput = document.getElementById('theme-search-input');
        const noThemesMessage = document.getElementById('no-themes-message');

        const confirmThemeTitle = document.getElementById('confirm-theme-title'); 
        const confirmThemeDescription = document.getElementById('confirm-theme-description'); 
        const startQuizBtn = document.getElementById('start-quiz-btn'); 
        const cancelQuizBtn = document.getElementById('cancel-quiz-btn'); 

        const quizThemeTitle = document.getElementById('quiz-theme-title');
        const questionCounter = document.getElementById('question-counter');
        const answerTypeDisplay = document.getElementById('answer-type-display'); 
        const questionText = document.getElementById('question-text');
        const userAnswerInput = document.getElementById('user-answer-input');
        const submitAnswerBtn = document.getElementById('submit-answer-btn');
        const validationMessage = document.getElementById('validation-message'); 
        const feedbackMessage = document.getElementById('feedback-message');
        const explanationText = document.getElementById('explanation-text'); 
        const finalScore = document.getElementById('final-score');
        const totalQuestions = document.getElementById('total-questions');
        const resultMessage = document.getElementById('result-message');
        const restartBtn = document.getElementById('restart-btn');

        // --- ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ ---
        let allThemes = []; 
        let currentQuizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        const MAX_QUESTIONS = 10;
        let selectedThemeId = null; 

        // ç”»é¢ã®åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        function showScreen(screenId) {
            loadingScreen.classList.add('hidden');
            themeSelectionScreen.classList.add('hidden');
            confirmationScreen.classList.add('hidden'); 
            quizScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');

            document.getElementById(screenId).classList.remove('hidden');
        }

        // --- æ­£è¦åŒ–ãƒ»ãƒ’ãƒ³ãƒˆé–¢æ•° ---

        /**
         * ã‚«ã‚¿ã‚«ãƒŠã‚’å¯¾å¿œã™ã‚‹ã²ã‚‰ãŒãªã«å¤‰æ›ã™ã‚‹
         */
        function katakanaToHiragana(str) {
            return str.replace(/[\u30a1-\u30f6]/g, function(match) {
                return String.fromCharCode(match.charCodeAt(0) - 0x60);
            });
        }

        /**
         * è§£ç­”ã‚’æ­£è¦åŒ– (æ–‡å­—ã®ç¨®é¡ã«åŸºã¥ã„ã¦å‡¦ç†ã‚’åˆ†ã‘ã‚‹)
         */
        function normalizeAnswer(answer, answerType = 'unlimited') {
            if (typeof answer !== 'string') return '';
            let normalized = answer.trim();

            if (answerType === 'number') {
                // å…¨è§’æ•°å­—ã‚’åŠè§’ã«å¤‰æ›ã—ã€ã‚¹ãƒšãƒ¼ã‚¹ã¯é™¤å»
                normalized = normalized
                    .replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
                    .replace(/[\sã€€]/g, '');
                // åˆ¤å®šæ™‚ã®ã¿ã€æ•°å­—ã€å°æ•°ç‚¹ã€ãƒã‚¤ãƒŠã‚¹ä»¥å¤–ã‚’å‰Šé™¤
                normalized = normalized.replace(/[^\d.\-]/g, '');
            } else if (answerType === 'alphabet') {
                // ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆä»¥å¤–ã‚’å‰Šé™¤ã—ã€å°æ–‡å­—åŒ–
                normalized = normalized.replace(/[^a-zA-Z]/g, '').toLowerCase();
            } else if (answerType === 'alpha_number') {
                // æ•°å­—ã¨ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆä»¥å¤–ã‚’å‰Šé™¤ã—ã€å°æ–‡å­—åŒ–ï¼ˆå…¨è§’æ•°å­—ã¯åŠè§’ã«å¤‰æ›ï¼‰
                normalized = normalized
                    .replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
                    .replace(/[\sã€€]/g, '')
                    .replace(/[^a-zA-Z0-9]/g, '')
                    .toLowerCase();
            } else if (answerType === 'kana') {
                // ä»®åæ–‡å­—ï¼ˆã²ã‚‰ãŒãªã€ã‚«ã‚¿ã‚«ãƒŠï¼‰ã€é•·éŸ³ç¬¦ã€Œãƒ¼ã€ä»¥å¤–ã®æ–‡å­—ã‚’å‰Šé™¤
                normalized = normalized.replace(/[\sã€€]/g, ''); 
                normalized = normalized.replace(/[^\u3040-\u309F\u30A0-\u30FFãƒ¼]/g, '');
                // ã‚«ã‚¿ã‚«ãƒŠã‚’ã²ã‚‰ãŒãªã«å¤‰æ›
                normalized = katakanaToHiragana(normalized);
            } else { // 'unlimited' (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
                // å…¨è§’ãƒ»åŠè§’ã‚¹ãƒšãƒ¼ã‚¹é™¤å»ã€ã‚«ã‚¿ã‚«ãƒŠâ†’ã²ã‚‰ãŒãªçµ±ä¸€ã€å°æ–‡å­—åŒ–
                normalized = normalized.replace(/[\sã€€]+/g, ''); 
                normalized = katakanaToHiragana(normalized);
                normalized = normalized.toLowerCase();
            }
            
            return normalized;
        }

        /**
         * answerTypeã«åŸºã¥ã„ãŸãƒ’ãƒ³ãƒˆãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹
         */
        function getAnswerHint(type) {
            switch (type) {
                case 'kana': return 'ä»®åæ–‡å­—ï¼ˆã²ã‚‰ãŒãª/ã‚«ã‚¿ã‚«ãƒŠï¼‰ã®ã¿';
                case 'alphabet': return 'ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ (A-Z) ã®ã¿';
                case 'number': return 'æ•°å­— (0-9, å°æ•°ç‚¹, -) ã®ã¿';
                case 'alpha_number': return 'ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã¨æ•°å­—ã®ã¿'; // æ–°ã—ã„ãƒ’ãƒ³ãƒˆ
                default: return 'åˆ¶é™ãªã—';
            }
        }
        
        /**
         * å…¥åŠ›æ–‡å­—ãŒæŒ‡å®šã•ã‚ŒãŸæ–‡å­—ç¨®ã®ã¿ã§æ§‹æˆã•ã‚Œã¦ã„ã‚‹ã‹ã‚’æ¤œè¨¼ã™ã‚‹
         */
        function isValidInput(input, answerType) {
            if (input === '') return true; // ç©ºæ–‡å­—ã¯å¸¸ã«è¨±å¯

            let regex;
            switch (answerType) {
                case 'kana':
                    // ã²ã‚‰ãŒãªã€ã‚«ã‚¿ã‚«ãƒŠã€é•·éŸ³ç¬¦ã€Œãƒ¼ã€ã€ã‚¹ãƒšãƒ¼ã‚¹ã€å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã®ã¿
                    regex = /^[ã-ã‚“ã‚¡-ãƒ¶ãƒ¼\sã€€]+$/;
                    break;
                case 'alphabet':
                    // ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã€ã‚¹ãƒšãƒ¼ã‚¹ã®ã¿
                    regex = /^[a-zA-Z\s]+$/;
                    break;
                case 'number':
                    // æ•°å­—ï¼ˆåŠè§’ãƒ»å…¨è§’ï¼‰ã€å°æ•°ç‚¹ã€ãƒã‚¤ãƒŠã‚¹ã€ã‚¹ãƒšãƒ¼ã‚¹ã®ã¿
                    regex = /^[0-9ï¼-ï¼™.\-\s]+$/; 
                    break;
                case 'alpha_number':
                    // ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã€æ•°å­—ï¼ˆåŠè§’ãƒ»å…¨è§’ï¼‰ã€ã‚¹ãƒšãƒ¼ã‚¹ã®ã¿
                    regex = /^[a-zA-Z0-9ï¼-ï¼™\s]+$/; 
                    break;
                case 'unlimited':
                default:
                    return true; // åˆ¶é™ãªã—
            }

            return regex.test(input);
        }

        // --- ãƒ‡ãƒ¼ã‚¿ã¨åˆæœŸåŒ– ---

        /**
         * ãƒ†ãƒ¼ãƒãƒªã‚¹ãƒˆã®æç”»é–¢æ•°
         */
        function renderThemes(themes) {
            themeList.innerHTML = ''; 
            noThemesMessage.classList.add('hidden'); 

            if (themes.length === 0) {
                noThemesMessage.classList.remove('hidden');
                return;
            }

            themes.forEach((theme) => {
                const button = document.createElement('button');
                button.textContent = theme.themeName;
                button.dataset.themeId = theme.id;
                button.className = 'btn-theme bg-indigo-500 text-white p-4 text-xl font-bold rounded-xl shadow-md hover:bg-indigo-600';
                button.addEventListener('click', () => showConfirmation(theme.id));
                themeList.appendChild(button);
            });
        }
        
        // é™çš„ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ†ãƒ¼ãƒä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        function loadThemes() {
            showScreen('loading-screen');
            allThemes = staticQuizzes; 

            renderThemes(allThemes);

            setTimeout(() => {
                showScreen('theme-selection-screen');
                themeSearchInput.value = '';
                themeSearchInput.focus();
            }, 300); 
        }
        
        /**
         * æ¤œç´¢å‡¦ç†
         */
        function handleSearch() {
            const query = normalizeAnswer(themeSearchInput.value, 'unlimited');
            
            const filteredThemes = allThemes.filter(theme => 
                normalizeAnswer(theme.themeName, 'unlimited').includes(query) ||
                normalizeAnswer(theme.id, 'unlimited').includes(query)
            );

            renderThemes(filteredThemes);
        }

        /**
         * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
         */
        function initApp() {
            loadThemes();

            // æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            themeSearchInput.addEventListener('input', handleSearch);
            // å…¥åŠ›æ¬„ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œè¨¼ã‚¤ãƒ™ãƒ³ãƒˆ
            userAnswerInput.addEventListener('input', validateInput);
        }

        /**
         * ç¢ºèªç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹
         */
        function showConfirmation(themeId) {
            const selectedTheme = allThemes.find(t => t.id === themeId);
            if (!selectedTheme) return;

            selectedThemeId = themeId; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿æŒ

            confirmThemeTitle.textContent = selectedTheme.themeName;
            confirmThemeDescription.textContent = selectedTheme.description || 'ãƒ†ãƒ¼ãƒã®èª¬æ˜ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';

            showScreen('confirmation-screen');
        }

        // --- ã‚²ãƒ¼ãƒ ãƒ•ãƒ­ãƒ¼é–¢æ•° ---

        // ã‚¯ã‚¤ã‚ºã®é–‹å§‹
        function startQuiz() {
            const themeId = selectedThemeId;
            if (!themeId) return;

            const selectedTheme = allThemes.find(t => t.id === themeId);
            if (!selectedTheme) {
                console.error("é¸æŠã•ã‚ŒãŸãƒ†ãƒ¼ãƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }

            currentQuizQuestions = selectRandomQuestions(selectedTheme.questions);
            currentQuestionIndex = 0;
            score = 0;

            if (currentQuizQuestions.length === 0) {
                 console.error("ã“ã®ãƒ†ãƒ¼ãƒã«ã¯å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚åˆ¥ã®ãƒ†ãƒ¼ãƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); 
                 loadThemes();
                 return;
            }

            // UIã‚’ãƒªã‚»ãƒƒãƒˆ
            quizThemeTitle.textContent = `${selectedTheme.themeName} ã‚¯ã‚¤ã‚º`;
            userAnswerInput.value = '';
            feedbackMessage.classList.add('hidden');
            explanationText.classList.add('hidden'); 
            validationMessage.classList.add('hidden'); 
            userAnswerInput.classList.remove('input-error'); 
            totalQuestions.textContent = currentQuizQuestions.length; 

            showNextQuestion();
            showScreen('quiz-screen');
        }

        // æ¬¡ã®å•é¡Œã®è¡¨ç¤º
        function showNextQuestion() {
            if (currentQuestionIndex < currentQuizQuestions.length) {
                const questionData = currentQuizQuestions[currentQuestionIndex];
                const answerType = questionData.answerType || 'unlimited';

                questionCounter.textContent = `å•é¡Œ ${currentQuestionIndex + 1} / ${currentQuizQuestions.length}`;
                questionText.textContent = questionData.question;
                userAnswerInput.value = '';
                submitAnswerBtn.textContent = 'è§£ç­”ã‚’æå‡º';
                submitAnswerBtn.disabled = true; 
                userAnswerInput.focus();
                
                feedbackMessage.classList.add('hidden');
                explanationText.classList.add('hidden'); 
                validationMessage.classList.add('hidden');
                userAnswerInput.classList.remove('input-error');

                // æ–‡å­—ã®ç¨®é¡ãƒ’ãƒ³ãƒˆã®è¡¨ç¤ºã‚’æ›´æ–°
                const inputHint = getAnswerHint(answerType);
                userAnswerInput.placeholder = `è§£ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (${inputHint})`;
                answerTypeDisplay.textContent = inputHint;

            } else {
                endQuiz();
            }
        }

        /**
         * å…¥åŠ›æ¤œè¨¼ã¨ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–ã‚’å‡¦ç†ã™ã‚‹
         */
        function validateInput() {
            if (currentQuestionIndex >= currentQuizQuestions.length) return;

            const userInput = userAnswerInput.value;
            const questionData = currentQuizQuestions[currentQuestionIndex];
            const answerType = questionData.answerType || 'unlimited';
            const buttonState = submitAnswerBtn.textContent;

            // 1. ç©ºãƒã‚§ãƒƒã‚¯
            if (userInput.trim() === '') {
                submitAnswerBtn.disabled = true;
                validationMessage.classList.add('hidden');
                userAnswerInput.classList.remove('input-error');
                return;
            }

            // 2. æ–‡å­—ç¨®æ¤œè¨¼
            const isValid = isValidInput(userInput, answerType);

            if (isValid) {
                // æœ‰åŠ¹ãªå…¥åŠ›ã®å ´åˆ
                // ãŸã ã—ã€è§£ç­”æå‡ºæ™‚ã®ã¿ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ã—ã€æ¬¡ã®å•é¡Œã¸ãƒœã‚¿ãƒ³æ™‚ã¯ç„¡åŠ¹åŒ–ã—ãªã„
                submitAnswerBtn.disabled = (buttonState !== 'è§£ç­”ã‚’æå‡º' && buttonState !== 'æ¬¡ã®å•é¡Œã¸' && buttonState !== 'çµæœã‚’è¦‹ã‚‹');
                validationMessage.classList.add('hidden');
                userAnswerInput.classList.remove('input-error');
            } else {
                // ä¸æ­£ãªæ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
                submitAnswerBtn.disabled = true;
                validationMessage.classList.remove('hidden');
                userAnswerInput.classList.add('input-error');
            }
        }

        // è§£ç­”ã®æå‡ºå‡¦ç†
        function submitAnswer() {
            if (currentQuestionIndex >= currentQuizQuestions.length || submitAnswerBtn.disabled) return;

            const userInput = userAnswerInput.value;
            // æå‡ºãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ç‚¹ã§ã€æ¬¡å›æŠ¼ä¸‹ã¾ã§ç„¡åŠ¹åŒ–
            submitAnswerBtn.disabled = true;

            const questionData = currentQuizQuestions[currentQuestionIndex];
            const answerType = questionData.answerType || 'unlimited';
            const correctAnswers = questionData.answers; 
            const canonicalAnswer = correctAnswers[0];
            const explanation = questionData.explanation || "ã“ã®å•é¡Œã«ã¯è§£èª¬ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"; 

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã¨æ­£è§£ãƒªã‚¹ãƒˆã‚’åŒã˜ãƒ«ãƒ¼ãƒ«ã§æ­£è¦åŒ–
            const normalizedUserInput = normalizeAnswer(userInput, answerType); 
            
            const isCorrect = correctAnswers.some(correctAnswer => 
                normalizeAnswer(correctAnswer, answerType) === normalizedUserInput
            );

            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ§‹ç¯‰
            let feedbackContent = '';
            if (isCorrect) {
                score++;
                feedbackContent = 'âœ… æ­£è§£ã§ã™ï¼';
                feedbackMessage.className = 'mt-4 p-3 rounded-lg text-center font-semibold bg-green-100 text-green-700';
            } else {
                feedbackContent = `âŒ ä¸æ­£è§£ã§ã™ã€‚æ­£è§£ã¯ã€Œ<span class="font-bold">${canonicalAnswer}</span>ã€ã§ã—ãŸã€‚`;
                feedbackMessage.className = 'mt-4 p-3 rounded-lg text-center font-semibold bg-red-100 text-red-700';
            }
            
            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¨è§£èª¬ã®è¡¨ç¤º
            feedbackMessage.innerHTML = feedbackContent;
            feedbackMessage.classList.remove('hidden');

            explanationText.textContent = `è§£èª¬: ${explanation}`;
            explanationText.classList.remove('hidden');

            // æ¬¡ã®ãƒœã‚¿ãƒ³ã«åˆ‡ã‚Šæ›¿ãˆ
            submitAnswerBtn.textContent = (currentQuestionIndex < currentQuizQuestions.length - 1) ? 'æ¬¡ã®å•é¡Œã¸' : 'çµæœã‚’è¦‹ã‚‹';
            // æ¬¡ã®ãƒœã‚¿ãƒ³ã¯ã™ãã«æœ‰åŠ¹åŒ–ã™ã‚‹
            submitAnswerBtn.disabled = false;
            submitAnswerBtn.onclick = handleNext;

            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
            userAnswerInput.removeEventListener('input', validateInput);
        }

        // æ¬¡ã¸/çµæœã¸ ã®ãƒœã‚¿ãƒ³å‡¦ç†
        function handleNext() {
            currentQuestionIndex++;
            showNextQuestion();
            // ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã¨å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆã‚’å…ƒã«æˆ»ã™
            submitAnswerBtn.onclick = submitAnswer;
            userAnswerInput.addEventListener('input', validateInput);
        }

        // ã‚¯ã‚¤ã‚ºã®çµ‚äº†
        function endQuiz() {
            finalScore.textContent = score;
            const total = currentQuizQuestions.length;
            totalQuestions.textContent = total;

            let message = "ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼";
            if (score === total) {
                message = "ğŸ‰ å…¨å•æ­£è§£ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ç´ æ™´ã‚‰ã—ã„ï¼";
            } else if (score >= total * 0.7) {
                message = "ğŸŒŸ ã‚ã¨å°‘ã—ï¼ã‚ˆãé ‘å¼µã‚Šã¾ã—ãŸã€‚";
            } else {
                message = "ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã¦ã€çŸ¥è­˜ã‚’æ·±ã‚ã¾ã—ã‚‡ã†ï¼";
            }
            resultMessage.textContent = message;

            showScreen('result-screen');
        }

        /**
         * é…åˆ—ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«æŒ‡å®šã•ã‚ŒãŸæœ€å¤§æ•°ï¼ˆMAX_QUESTIONSï¼‰ã®å•é¡Œã‚’æŠ½å‡ºã™ã‚‹
         */
        function selectRandomQuestions(allQuestions) {
            const maxCount = MAX_QUESTIONS;
            if (!allQuestions || allQuestions.length === 0) {
                return [];
            }
            if (allQuestions.length <= maxCount) {
                // å•é¡Œæ•°ãŒå°‘ãªã„å ´åˆã¯ã€ãã®ã¾ã¾ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦è¿”ã™
                const shuffled = allQuestions.slice(); 
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }

            // Fisher-Yates (Knuth) ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã§10å•ã‚’æŠ½å‡º
            const shuffled = allQuestions.slice(); 
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            
            return shuffled.slice(0, maxCount); 
        }


        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š ---
        startQuizBtn.addEventListener('click', startQuiz);
        cancelQuizBtn.addEventListener('click', loadThemes); 
        submitAnswerBtn.addEventListener('click', submitAnswer);
        
        // Enterã‚­ãƒ¼ã§è§£ç­”ã‚’æå‡º/æ¬¡ã¸
        userAnswerInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); 
                if (submitAnswerBtn.textContent === 'è§£ç­”ã‚’æå‡º' && !submitAnswerBtn.disabled) {
                    submitAnswer();
                } else if (submitAnswerBtn.textContent !== 'è§£ç­”ã‚’æå‡º' && !submitAnswerBtn.disabled) {
                    handleNext();
                }
            }
        });

        restartBtn.addEventListener('click', loadThemes);

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹å§‹
        window.onload = initApp;

    </script>
</body>
</html>

